<script>
    // 从url中获取某个参数的值
    function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    // 得到设备ID
    var device_id = getParameterByName('device_id');
    // 如果设备ID不为空，则执行连接MQTT的操作
    if ( device_id !== null ){
        ez_connect(device_id);
    }
    // 连接MQTT服务
    function ez_connect(device_id) {
        // 获取access_token
        // access_token是公众号的全局唯一票据，公众号调用各接口时都需使用access_token。
        // 正常情况下access_token有效期为7200秒，重复获取将导致上次获取的access_token失效
        var access_token = getParameterByName('access_token')
        // websocket连接
        // wsbroker:host
        // wsport:端口 默认1983
        // Client-ID ： v1_web_[MAC]  //版本号_app_手机MAC(必须是12位小写)
        var wsbroker = "api.easylink.io";  //mqtt websocket enabled broker
        var wsport = 1983 // port for above
        var client = new Paho.MQTT.Client(wsbroker, wsport, "v1-web-" + parseInt(Math.random() * 1000000, 12));
        // 基本参数配置
        // 连接丢失所对应的callback函数
        client.onConnectionLost = onConnectionLost;
        // 消息到达所对应的callback函数
        client.onMessageArrived = onMessageArrived;
        // 连接成功所对应的callback函数        
        client.connect({onSuccess:onConnect});
        // 连接成功
        function onConnect() {
            var subtopic = device_id+'/out/#';
            // Once a connection has been made, make a subscription and send a message.
            // 向某个通道发送指令
            // topic：通道
            // commond：指令
            client.publish = function(topic, commond) {
                // console.log("现在执行-->:"+commond);
                message = new Paho.MQTT.Message(commond);
                message.destinationName = topic;
                client.send(message);
            }
            // console.log("device_id:"+device_id);
            console.log("onConnect");
            client.subscribe(subtopic, {qos: 0});
        }
        // 连接丢失
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0)
                console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        // 消息到达
        // var msgindex = 1;
        var msgjson;
        function onMessageArrived(message) {
            msgjson = $.parseJSON(message.payloadString);
            var tempval = msgjson.dht11_temperature;
            if("undefined" != typeof(tempval)){
                // 显示温度
                $("#tempid").text(tempval+"℃");
                // 显示湿度
                $("#humiid").text(msgjson.dht11_humidity+'%');
                // 温度超过29则红灯亮，20-29之间则绿灯亮，低于20黄灯亮
                if(tempval > "29"){
                    led_red();
                    $("#rgbimgid").attr("src", "./image/02-red.svg");
                }else if(tempval < "30" && (tempval > "19")){
                    led_green();
                    $("#rgbimgid").attr("src", "./image/02-green.svg");
                }else if(tempval < "20"){
                    led_yellow();
                    $("#rgbimgid").attr("src", "./image/02-yellow.svg");
                }
            }
        }
        // 控制按钮显示的事件
        $("#switchbtn").click(function() {
            var topic = device_id+'/in';
            var commond;
            var swtimg = $("#switchbtn").attr("src");
            if("./image/03-turn-on.svg" == swtimg){
                commond = '{"device_switch":false}';
                $("#switchbtn").attr("src", "./image/03-turn-off.svg");
                $("#switchspan").text("关");
            }else{
                commond = '{"device_switch":true}';
                $("#switchbtn").attr("src", "./image/03-turn-on.svg");
                $("#switchspan").text("开");
            }
            client.publish(topic, commond);
        });
        function led_red() {
            var topic = device_id+'/in';
            var commond = '{"rgbled_switch":true,"rgbled_hues":0, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        function led_green() {
            var topic = device_id+'/in';
            var commond = '{"rgbled_switch":true,"rgbled_hues":120, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
        function led_yellow() {
            var topic = device_id+'/in';
            var commond = '{"rgbled_switch":true,"rgbled_hues":60, "rgbled_saturation":100, "rgbled_brightness":100}'; 
            client.publish(topic, commond);
        }
}
</script>
